<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Central de Jogos Otimizada</title>
    
    <!-- Scripts Externos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>

    <style>
        /* Otimiza√ß√µes de Performance e UI */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: #006064;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overscroll-behavior-y: contain; /* Evita puxar a p√°gina no mobile */
            -webkit-tap-highlight-color: transparent;
        }

        .game-container {
            width: 100%;
            max-width: 600px; /* Limitado para melhor performance visual */
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            padding: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 8px solid white;
            background-color: rgba(255, 255, 255, 0.9);
            position: relative;
        }

        .game-section {
            display: none; /* O segredo da performance: esconde em vez de destruir */
            width: 100%;
            animation: fadeIn 0.3s ease;
        }

        .game-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-menu {
            display: flex;
            justify-content: center;
            border-bottom: 2px solid #b2ebf2;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tab-btn {
            padding: 10px 15px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #00796b;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: #e0f7fa;
            border-bottom: 3px solid #00bfa5;
            color: #004d40;
        }

        /* OTIMIZA√á√ÉO CR√çTICA: touch-action none para evitar scroll enquanto desenha */
        #confettiCanvas, #drawingCanvas, #drawingArea {
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }

        #confettiCanvas {
            width: 100%;
            height: 400px;
            background-color: #f0fdfa;
            background-image: url('https://i.postimg.cc/wBvjgdWm/054d7f95-28c1-4cca-9f0a-6262b04f0bab.png');
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            border: 2px solid #b2ebf2;
        }

        #drawingArea {
            position: relative;
            width: 100%;
            height: 400px; /* Altura fixa ajuda na performance */
            background-image: url('https://i.postimg.cc/Wb4BsmdQ/ddddddd.jpg');
            background-size: cover;
            background-position: center;
            border: 2px solid #a7ffeb;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        #drawingArea canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 5;
            pointer-events: none; /* Deixa passar clique se n√£o estiver desenhando */
        }
        
        #drawingArea canvas.drawing-active {
            pointer-events: auto; /* Captura clique quando desenhando */
        }

        .accessory-wrapper {
            position: absolute;
            z-index: 10;
            touch-action: none;
        }
        
        .accessory-wrapper.active {
            border: 2px dashed #ff4081;
            z-index: 20;
        }

        .accessory-wrapper img {
            width: 100%; height: 100%;
            pointer-events: none;
            display: block;
        }

        .handle {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0; transition: opacity 0.2s;
        }

        .accessory-wrapper.active .handle { opacity: 1; }

        .delete-handle { top: -15px; right: -15px; background: #ef4444; font-size: 14px; cursor: pointer; }
        .resize-handle { bottom: -15px; right: -15px; background: #00bfa5; cursor: nwse-resize; border: 2px solid white; }

        #accessoriesContainer {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
            background: #e0f2f7;
            border-radius: 12px;
            scrollbar-width: thin;
        }

        .accessory-item {
            min-width: 60px; height: 60px;
            background: white;
            border: 2px solid #b2ebf2;
            border-radius: 8px;
            padding: 5px;
            cursor: pointer;
        }
        
        .tool-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.75rem;
            text-transform: uppercase;
            border: 1px solid #b2ebf2;
            background: white;
            transition: all 0.2s;
        }
        .tool-btn.active {
            background: #00bfa5; color: white; transform: scale(1.05); border-color: #00897b;
        }

        #rankingModal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 50;
            align-items: center; justify-content: center; padding: 20px;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1 class="text-2xl font-black text-teal-700 uppercase tracking-tighter">Central de Jogos</h1>
        
        <div class="tab-menu" id="tabMenu">
            <button class="tab-btn active" onclick="switchGame('confetti')">Confetche!</button>
            <button class="tab-btn" onclick="switchGame('customizer')">Me deixe bonito!</button>
            <button class="tab-btn" onclick="switchGame('oraculo')">Or√°culo</button>
        </div>

        <!-- Jogo 1: Confetti -->
        <div id="game-confetti" class="game-section active">
            <div id="gameOverOverlay" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center rounded-2xl p-6">
                <h2 class="text-2xl font-black text-red-600 uppercase mb-2">Perdeu!</h2>
                <input id="playerNick" type="text" placeholder="Seu Nick" class="border-4 border-teal-500 p-3 rounded-xl mb-4 text-center w-full font-bold">
                <button id="saveBtn" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg mb-4">SALVAR PONTOS</button>
                <button onclick="resetConfetti()" class="text-gray-500 font-bold underline">Tentar de novo</button>
            </div>

            <div class="flex justify-between items-center mb-2 px-2">
                <div class="font-bold text-teal-800 bg-teal-100 px-3 py-1 rounded-lg">PTS: <span id="scoreDisplay">0</span></div>
                <button onclick="openRanking()" class="bg-yellow-400 hover:bg-yellow-500 text-white p-2 rounded-full shadow transition">üèÜ</button>
                <div class="font-bold text-red-500 bg-red-100 px-3 py-1 rounded-lg">ERROS: <span id="missDisplay">0</span>/10</div>
            </div>
            <canvas id="confettiCanvas"></canvas>
        </div>

        <!-- Jogo 2: Customizador -->
        <div id="game-customizer" class="game-section">
            <div class="flex gap-2 justify-center mb-2 flex-wrap">
                <button id="btn-select" class="tool-btn active" onclick="setTool('select')">üëÜ Mover</button>
                <button id="btn-brush" class="tool-btn" onclick="setTool('brush')">üñåÔ∏è Pincel</button>
                <button id="btn-eraser" class="tool-btn" onclick="setTool('eraser')">üßΩ Apagar</button>
                <input type="color" id="brushColor" value="#000000" class="h-8 w-8 rounded cursor-pointer">
                <button class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold" onclick="clearCanvas()">LIMPAR</button>
            </div>

            <div id="drawingArea">
                <canvas id="drawingCanvas"></canvas>
            </div>

            <div id="accessoriesContainer">
                <!-- Acess√≥rios gerados via JS -->
            </div>
        </div>

        <!-- Jogo 3: Or√°culo -->
        <div id="game-oraculo" class="game-section">
            <div class="bg-indigo-900 p-6 rounded-2xl text-white text-center border-4 border-indigo-500">
                <h2 class="text-xl font-black mb-4 uppercase italic">üîÆ Que Luisinho voc√™ √©?</h2>
                <div id="meme-container" class="min-h-[300px] flex flex-col items-center justify-center bg-indigo-950/50 rounded-lg p-4 mb-4 border border-indigo-500/30">
                    <p id="meme-txt" class="text-yellow-300 font-bold text-lg text-center">Clique para revelar seu destino...</p>
                    <img id="meme-img" class="hidden max-h-[220px] rounded-lg border-2 border-white mt-4 shadow-xl object-contain">
                </div>
                <button onclick="revealMeme()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 font-black rounded-xl shadow-lg active:scale-95 transition">
                    üé≤ REVELAR AGORA
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ranking -->
    <div id="rankingModal" onclick="if(event.target === this) closeRanking()">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl relative animate-bounce-in">
            <h2 class="text-2xl font-black text-teal-700 mb-4 text-center">üèÜ RANKING</h2>
            <div id="rankingList" class="max-h-[60vh] overflow-y-auto space-y-2 mb-4">
                <p class="text-center text-gray-400">Carregando...</p>
            </div>
            <button onclick="closeRanking()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">FECHAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO GLOBAL E FIREBASE ---
        let db, auth, appId, user = null, userNick = '';
        
        async function initFirebase() {
            try {
                if (typeof __firebase_config === 'undefined') return;
                const config = JSON.parse(__firebase_config);
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
                
                firebase.auth().onAuthStateChanged((u) => {
                    user = u;
                    if(user) loadUserNick();
                });
            } catch(e) { console.error("Erro Firebase", e); }
        }

        async function loadUserNick() {
            if(!user) return;
            try {
                const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('ranking').where('userId', '==', user.uid).get();
                if(!snapshot.empty) userNick = snapshot.docs[0].data().nick;
            } catch(e){}
        }

        // --- SISTEMA DE ABAS (PERFORMANCE: Apenas troca display) ---
        function switchGame(gameId) {
            document.querySelectorAll('.game-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`game-${gameId}`).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const btns = document.querySelectorAll('.tab-btn');
            
            if(gameId === 'confetti') {
                btns[0].classList.add('active');
                // Corre√ß√£o: For√ßa redimensionamento ap√≥s o layout estar vis√≠vel
                requestAnimationFrame(() => {
                    resizeConfetti();
                    isConfettiRunning = true;
                    loopConfetti();
                });
            }
            if(gameId === 'customizer') {
                btns[1].classList.add('active');
                initCustomizerOnce();
            }
            if(gameId === 'oraculo') {
                btns[2].classList.add('active');
                isConfettiRunning = false;
            }
        }

        // --- JOGO 1: CONFETTI ---
        const confettiCanvas = document.getElementById('confettiCanvas');
        const ctxConfetti = confettiCanvas.getContext('2d');
        let confettiScore = 0, confettiMisses = 0, isConfettiRunning = true;
        let particles = [];
        let man = { x: 50, y: 200, dx: 3, dy: 2, state: 'idle', timer: 0 };
        
        // Imagens do confete (Carregamento √önico)
        const imgs = { 
            idle: new Image(), open: new Image(), cough: new Image() 
        };
        imgs.idle.src = 'https://i.postimg.cc/XvhMHHx2/fechando.png';
        imgs.open.src = 'https://i.postimg.cc/kgTP8XSP/6a575d21-32c4-4876-abc2-99943e746c78.png';
        imgs.cough.src = 'https://i.postimg.cc/jS0bKFrB/tosse-esse-sim.png';

        function resizeConfetti() {
            // Garante que o canvas pegue o tamanho real, mesmo se carregou oculto
            const rect = confettiCanvas.getBoundingClientRect();
            if (rect.width > 0) {
                confettiCanvas.width = rect.width;
                confettiCanvas.height = 400; // For√ßa altura fixa do CSS
            } else {
                // Fallback se rect for 0 (elemento oculto)
                confettiCanvas.width = confettiCanvas.parentElement.offsetWidth || 300;
                confettiCanvas.height = 400;
            }

            // Centraliza o boneco se ele estiver fora da tela
            if (man.x > confettiCanvas.width - 150 || man.x < 0) man.x = (confettiCanvas.width / 2) - 75;
            if (man.y > confettiCanvas.height - 180 || man.y < 0) man.y = 200;
        }
        window.addEventListener('resize', resizeConfetti);
        
        // Adiciona part√≠cula
        const addParticle = (e) => {
            if(!isConfettiRunning || confettiMisses >= 10) return;
            const rect = confettiCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            particles.push({
                x: clientX - rect.left,
                y: clientY - rect.top,
                speed: -4 - Math.random() * 2,
                color: `hsl(${Math.random()*360}, 100%, 50%)`
            });
        };
        confettiCanvas.addEventListener('mousedown', addParticle);
        confettiCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); addParticle(e); }, {passive: false});

        function loopConfetti() {
            if(!isConfettiRunning) return;
            
            ctxConfetti.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            
            // L√≥gica do Homem com limites de tela seguros
            man.x += man.dx; 
            man.y += man.dy;

            // Colis√µes com as bordas (com margem de seguran√ßa)
            if(man.x <= 0 || man.x >= confettiCanvas.width - 150) man.dx *= -1;
            if(man.y <= 20 || man.y >= confettiCanvas.height - 180) man.dy *= -1;

            // Anima√ß√£o de estado
            if(man.state !== 'cough') {
                if(Date.now() % 2000 < 1000) man.state = 'open';
                else man.state = 'idle';
            } else {
                man.timer--;
                if(man.timer <= 0) man.state = 'idle';
            }

            let currentImg = man.state === 'cough' ? imgs.cough : (man.state === 'open' ? imgs.open : imgs.idle);
            // Desenha a imagem
            if (currentImg.complete) {
                ctxConfetti.drawImage(currentImg, man.x, man.y, 150, 180);
            }

            // Part√≠culas
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.y += p.speed;
                ctxConfetti.fillStyle = p.color;
                ctxConfetti.beginPath();
                ctxConfetti.arc(p.x, p.y, 6, 0, Math.PI*2);
                ctxConfetti.fill();

                // Colis√£o simples
                if (p.x > man.x + 40 && p.x < man.x + 110 && p.y > man.y + 40 && p.y < man.y + 100) {
                    confettiScore++;
                    document.getElementById('scoreDisplay').innerText = confettiScore;
                    man.state = 'cough'; man.timer = 20;
                    particles.splice(i, 1);
                } else if (p.y < -10) {
                    confettiMisses++;
                    document.getElementById('missDisplay').innerText = confettiMisses;
                    particles.splice(i, 1);
                    if(confettiMisses >= 10) gameOver();
                }
            }

            requestAnimationFrame(loopConfetti);
        }

        function gameOver() {
            isConfettiRunning = false;
            document.getElementById('gameOverOverlay').classList.remove('hidden');
            document.getElementById('gameOverOverlay').classList.add('flex');
            if(document.getElementById('playerNick')) document.getElementById('playerNick').value = userNick;
        }

        window.resetConfetti = () => {
            confettiScore = 0; confettiMisses = 0; particles = [];
            // Reseta posi√ß√£o do boneco para o centro para evitar bugs
            man.x = (confettiCanvas.width / 2) - 75;
            man.y = 200;
            
            document.getElementById('scoreDisplay').innerText = 0;
            document.getElementById('missDisplay').innerText = 0;
            document.getElementById('gameOverOverlay').classList.add('hidden');
            document.getElementById('gameOverOverlay').classList.remove('flex');
            isConfettiRunning = true;
            resizeConfetti(); // Garante tamanho correto
            loopConfetti();
        };

        // Salvar Ranking
        document.getElementById('saveBtn').onclick = async () => {
            const nick = document.getElementById('playerNick').value || 'An√¥nimo';
            const btn = document.getElementById('saveBtn');
            btn.innerText = "SALVANDO...";
            
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('ranking').add({
                    userId: user.uid,
                    nick: nick,
                    score: confettiScore,
                    timestamp: Date.now()
                });
                userNick = nick;
                resetConfetti();
            } catch(e) { console.error(e); }
            btn.innerText = "SALVAR PONTOS";
        };

        // --- JOGO 2: CUSTOMIZADOR OTIMIZADO ---
        let customizerInitialized = false;
        let drawingCanvas, drawingCtx, currentTool = 'select';
        let isDrawing = false;
        let canvasRect = null; // CACHE IMPORTANTE

        const accessories = [
            { src: "https://i.postimg.cc/XvxPGjJw/perucawws.png" },
            { src: "https://i.postimg.cc/XJJz9RGt/perucas.png" },
            { src: "https://i.postimg.cc/N0w4gWkT/Captura-de-tela-2025-11-30-190254.png" },
            { src: "https://i.postimg.cc/MGcKZpq9/a214595cb778d15d02a04495c94e14b3.png" },
            { src: "https://i.postimg.cc/kDrY3D1P/SACO-OVO.png" },
            { src: "https://i.postimg.cc/m2j4BwSM/bigode.png" },
            { src: "https://i.postimg.cc/XY2nc8Gd/make.png" },
            { src: "https://i.postimg.cc/D058JpDM/ddddddd.png" },
            { src: "https://i.postimg.cc/RZkLGqsZ/Captura-de-tela-2025-11-30-195023.png" },
            { src: "https://i.postimg.cc/MpjnsHR1/Captura-de-tela-2025-11-30-191447.png" }
        ];

        function initCustomizerOnce() {
            if (customizerInitialized) return;
            customizerInitialized = true;

            drawingCanvas = document.getElementById('drawingCanvas');
            drawingCtx = drawingCanvas.getContext('2d');
            const area = document.getElementById('drawingArea');

            // Ajusta tamanho do canvas (IMPORTANTE: Fazer isso uma vez evita blur)
            drawingCanvas.width = area.offsetWidth;
            drawingCanvas.height = area.offsetHeight;

            // Preenche menu de acess√≥rios
            const container = document.getElementById('accessoriesContainer');
            accessories.forEach(acc => {
                const img = document.createElement('img');
                img.src = acc.src;
                img.className = 'accessory-item';
                img.onclick = () => addAccessory(acc.src);
                container.appendChild(img);
            });

            // Eventos de Desenho OTIMIZADOS
            const startDraw = (e) => {
                if (currentTool === 'select') return;
                isDrawing = true;
                
                // ATUALIZA RECT AQUI, N√ÉO NO MOVE
                canvasRect = drawingCanvas.getBoundingClientRect();
                
                drawingCtx.beginPath();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - canvasRect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - canvasRect.top;
                drawingCtx.moveTo(x, y);
            };

            const moveDraw = (e) => {
                if (!isDrawing || currentTool === 'select') return;
                // e.preventDefault() j√° √© tratado pelo passive: false ou touch-action css
                
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - canvasRect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - canvasRect.top;

                drawingCtx.lineTo(x, y);
                drawingCtx.strokeStyle = document.getElementById('brushColor').value;
                drawingCtx.lineWidth = 5;
                drawingCtx.lineCap = 'round';
                drawingCtx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
                drawingCtx.stroke();
            };

            const endDraw = () => { isDrawing = false; };

            drawingCanvas.addEventListener('mousedown', startDraw);
            drawingCanvas.addEventListener('mousemove', moveDraw);
            window.addEventListener('mouseup', endDraw);

            drawingCanvas.addEventListener('touchstart', (e) => { 
                if(currentTool !== 'select') e.preventDefault(); 
                startDraw(e); 
            }, {passive: false});
            
            drawingCanvas.addEventListener('touchmove', (e) => { 
                if(currentTool !== 'select') e.preventDefault(); 
                moveDraw(e); 
            }, {passive: false});
            
            window.addEventListener('touchend', endDraw);

            // Clique na √°rea deseleciona itens
            area.addEventListener('click', (e) => {
                if(e.target === area || e.target === drawingCanvas) {
                    document.querySelectorAll('.accessory-wrapper').forEach(el => el.classList.remove('active'));
                }
            });
        }

        window.setTool = (tool) => {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${tool}`).classList.add('active');
            
            const canvas = document.getElementById('drawingCanvas');
            if(tool === 'select') {
                canvas.classList.remove('drawing-active');
            } else {
                canvas.classList.add('drawing-active');
                // Deseleciona acess√≥rios ao entrar em modo desenho
                document.querySelectorAll('.accessory-wrapper').forEach(el => el.classList.remove('active'));
            }
        };

        window.clearCanvas = () => {
            if(drawingCtx) drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            document.querySelectorAll('.accessory-wrapper').forEach(el => el.remove());
        };

        function addAccessory(src) {
            const area = document.getElementById('drawingArea');
            const wrapper = document.createElement('div');
            wrapper.className = 'accessory-wrapper active';
            wrapper.style.left = '50px';
            wrapper.style.top = '50px';
            wrapper.style.width = '100px';
            wrapper.style.height = '100px';
            
            wrapper.innerHTML = `
                <img src="${src}">
                <div class="handle delete-handle">X</div>
                <div class="handle resize-handle"></div>
            `;

            // L√≥gica de Arrastar OTIMIZADA
            let isDragging = false, isResizing = false;
            let startX, startY, startW, startH, initialLeft, initialTop;

            const onStart = (e) => {
                if(currentTool !== 'select') return;
                e.stopPropagation(); // Evita desenhar
                
                // Ativa este, desativa outros
                document.querySelectorAll('.accessory-wrapper').forEach(el => el.classList.remove('active'));
                wrapper.classList.add('active');

                if (e.target.classList.contains('delete-handle')) {
                    wrapper.remove();
                    return;
                }

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                if (e.target.classList.contains('resize-handle')) {
                    isResizing = true;
                    startW = wrapper.offsetWidth;
                    startH = wrapper.offsetHeight;
                    startX = clientX;
                    startY = clientY;
                } else {
                    isDragging = true;
                    startX = clientX;
                    startY = clientY;
                    initialLeft = wrapper.offsetLeft;
                    initialTop = wrapper.offsetTop;
                }
            };

            const onMove = (e) => {
                if (!isDragging && !isResizing) return;
                e.preventDefault(); // Importante no mobile

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                if (isDragging) {
                    const dx = clientX - startX;
                    const dy = clientY - startY;
                    wrapper.style.left = `${initialLeft + dx}px`;
                    wrapper.style.top = `${initialTop + dy}px`;
                } else if (isResizing) {
                    const dx = clientX - startX;
                    // Mant√©m propor√ß√£o simples
                    const newW = Math.max(30, startW + dx);
                    wrapper.style.width = `${newW}px`;
                    wrapper.style.height = `${newW}px`; // Mant√©m quadrado/proporcional
                }
            };

            const onEnd = () => { isDragging = false; isResizing = false; };

            wrapper.addEventListener('mousedown', onStart);
            wrapper.addEventListener('touchstart', onStart, {passive: false});
            
            // Adiciona listeners globais tempor√°rios para movimento suave
            window.addEventListener('mousemove', onMove);
            window.addEventListener('touchmove', onMove, {passive: false});
            window.addEventListener('mouseup', onEnd);
            window.addEventListener('touchend', onEnd);

            area.appendChild(wrapper);
        }

        // --- JOGO 3: OR√ÅCULO OTIMIZADO (SEM REPETI√á√ïES) ---
        const MEMES = [
            { text: "ü¶Å LUISINHO FULL PISTOLA: Hoje quem te der 'bom dia' vai levar um coice!", img: "https://i.postimg.cc/fLsbj21L/642e8812-6b1b-4da5-8654-43fed94f3ac5.jpg" },
            { text: "üï∫ LUISINHO INIMIGO DO FIM: Tomou 3 energ√©ticos e vai dan√ßar at√© no vel√≥rio!", img: "https://i.postimg.cc/B6Cnh5GM/20250902-203254.jpg" },
            { text: "üí∏ LUISINHO MAGNATA DO PIX: Caiu 2 reais na conta e j√° quer financiar uma Ferrari.", img: "https://i.postimg.cc/nV0LB1kw/Captura-de-tela-2025-12-09-153113.jpg" },
            { text: "üíÖ LUISINHO BLOGUEIRINHA: Fazendo a pose pro print porque o deboche √© meu sobrenome.", img: "https://i.postimg.cc/28WXPC6C/Captura-de-tela-2025-12-21-141211.png" },
            { text: "üßê LUISINHO ANALISTA: Te julgando silenciosamente por essa sua cara de sono.", img: "https://i.postimg.cc/pLNYMxFG/Captura-de-tela-2025-05-19-205622.png" },
            { text: "ü§° LUISINHO CORINGOU: Rindo de nervoso porque o boleto venceu e voc√™ esqueceu.", img: "https://i.postimg.cc/Dz6qGXM2/Captura-de-tela-2025-06-11-233239.png" },
            { text: "üò≤ LUISINHO PASSADO: Viu a fofoca e ficou em choque com o n√≠vel da aud√°cia.", img: "https://i.postimg.cc/wjdJbVCW/Captura-de-tela-2025-12-20-172039.png" },
            { text: "ü§® LUISINHO DESCONFIADO: Hummm, sei n√£o hein... essa sua hist√≥ria t√° mais mal contada!", img: "https://i.postimg.cc/CxVD67yh/Captura-de-tela-2025-12-20-172050.jpg" },
            { text: "ü§´ LUISINHO SIGILO TOTAL: Guardando o segredo que vai destruir a reputa√ß√£o de algu√©m.", img: "https://i.postimg.cc/HLYMTLsJ/Captura-de-tela-2025-12-20-172912.jpg" },
            { text: "üíÄ LUISINHO ALMA SAINDO: Quando a segunda-feira chega e voc√™ ainda n√£o superou o s√°bado.", img: "https://i.postimg.cc/zB3RRPh8/Captura-de-tela-2025-12-20-172946.png" },
            { text: "ü•¥ LUISINHO P√ìS-LIVE: A cara de quem n√£o dorme h√° 3 dias por causa de v√≠cio em jogo.", img: "https://i.postimg.cc/W3tJJfZ7/Captura-de-tela-2025-12-20-173450.png" },
            { text: "üò∂ LUISINHO SEM PALAVRAS: A burrice alheia √†s vezes atinge n√≠veis astron√¥micos.", img: "https://i.postimg.cc/RF8J1QQB/Captura-de-tela-2025-12-20-173530.png" },
            { text: "üî• LUISINHO MODE ON: Se me irritar hoje, o barraco vai ser transmitido via sat√©lite.", img: "https://i.postimg.cc/vTVg0g3D/Captura-de-tela-2025-12-20-173556.png" },
            { text: "üé≠ LUISINHO DRAM√ÅTICO: Sofrendo mais que vil√£o de novela mexicana porque o Wi-Fi caiu!", img: "https://i.postimg.cc/0yxZFmFS/Captura-de-tela-2025-05-19-212628.png" },
            { text: "üòé LUISINHO DONO DA RAZ√ÉO: Eu n√£o discuto, eu apenas explico por que voc√™ est√° errado.", img: "https://i.postimg.cc/CKx7L0FR/Captura-de-tela-2025-06-02-143116.png" },
            { text: "üò¥ LUISINHO DERROTADO: A vida bateu tanto hoje que o plano √© s√≥ virar um vegetal.", img: "https://i.postimg.cc/908F2W0H/Captura-de-tela-2025-12-09-152444.jpg" },
            { text: "üåΩ LUISINHO 'T√î NEM A√ç': O mundo pode acabar em fogo, eu vou estar aqui com meu milho.", img: "https://i.postimg.cc/jqZjPhcR/Captura-de-tela-2025-12-09-153135.jpg" },
            { text: "ü§Ø LUISINHO PANE NO SISTEMA: Viu o pre√ßo da carne e a alma saiu do corpo!", img: "https://i.postimg.cc/GhtmQsgh/e1eef602-b7bb-42ee-bae8-f5f99b3ba7ec.jpg" },
            { text: "üöÄ LUISINHO ESTOURADO: Esquece, o pai t√° viciado em vencer !", img: "https://i.postimg.cc/L6W606GB/Gemini-Generated-Image-t1rwy1t1rwy1t1rw.jpg" }
        ];

        let lastMemeIndex = -1;

        window.revealMeme = () => {
            const txt = document.getElementById('meme-txt');
            const img = document.getElementById('meme-img');
            
            txt.innerText = "üîÆ Consultando os astros...";
            img.classList.add('hidden');
            
            setTimeout(() => {
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * MEMES.length);
                } while (newIndex === lastMemeIndex && MEMES.length > 1);
                
                lastMemeIndex = newIndex;
                const random = MEMES[newIndex];
                
                txt.innerText = random.text;
                img.src = random.img;
                img.onload = () => img.classList.remove('hidden');
            }, 800);
        };

        // --- RANKING ---
        window.openRanking = () => {
            document.getElementById('rankingModal').style.display = 'flex';
            const list = document.getElementById('rankingList');
            list.innerHTML = '<p class="text-center text-gray-500">Carregando...</p>';
            
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('ranking')
                .orderBy('score', 'desc')
                .limit(20)
                .get()
                .then(snap => {
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<p class="text-center">Sem recordes ainda!</p>'; return; }
                    
                    snap.forEach((doc, idx) => {
                        const d = doc.data();
                        const isMe = user && d.userId === user.uid;
                        list.innerHTML += `
                            <div class="flex justify-between items-center p-3 rounded ${isMe ? 'bg-indigo-100 border-l-4 border-indigo-500' : 'bg-gray-100'}">
                                <span class="font-bold text-gray-700">${idx+1}. ${d.nick}</span>
                                <span class="font-black text-teal-600">${d.score}</span>
                            </div>
                        `;
                    });
                });
        };
        
        window.closeRanking = () => document.getElementById('rankingModal').style.display = 'none';

        // Inicializa
        window.onload = () => {
            initFirebase();
            switchGame('confetti');
            // Garante redimensionamento inicial do confetti
            setTimeout(resizeConfetti, 500);
        };

    </script>
</body>
</html>
